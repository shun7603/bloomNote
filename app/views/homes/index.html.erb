<%= javascript_importmap_tags "home" %>

<% if @children.blank? %>
  <!-- 子ども未登録の場合のダミー表示 -->
  <div class="container p-3" style="max-width: 420px; background-color: #fffefc; border-radius: 20px; border: 1px solid #ddd;">
    <div class="text-center">
      <h3 class="fw-bold">BloomNote</h3>
      <p class="text-muted">まずは子どもを登録してください。</p>
      <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#childModal">＋ 子ども登録</button>
    </div>
  </div>
<% else %>
  <!-- 子どもが登録されている場合の表示 -->
  <div class="container p-3" style="max-width: 420px; background-color: #fffefc; border-radius: 20px; border: 1px solid #ddd;">

    <!-- ヘッダー -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-bold">BloomNote</h3>
      <i class="bi bi-list fs-3"></i>
    </div>

    <h4 class="fw-bold mb-2">ルーティン</h4>


    <!-- 機能ボタン -->
    <div class="text-center my-3">
      <button class="btn btn-outline-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#childModal">＋ 子ども登録</button>
      <button class="btn btn-outline-success rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#routineModal">＋ ルーティン追加</button>
      <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#editChildModal">⚙ 子ども編集</button>
    </div>

    <!-- 今日の記録 -->
    <h5 class="fw-bold">今日の記録</h5>
    <ul class="list-unstyled">
      <% if @records.present? %>
        <% @records.each do |record| %>
          <li><%= record.recorded_at.strftime("%H:%M") %>　<%= record.record_type_i18n %> <%= record.quantity %></li>
        <% end %>
      <% else %>
        <p class="text-muted">記録はまだありません</p>
      <% end %>
    </ul>

    <!-- 緊急連絡 -->
    <div class="bg-light rounded p-2 my-3 d-flex align-items-center">
      <i class="bi bi-telephone-fill me-2" style="font-size: 1.3rem;"></i>
      <strong>緊急連絡</strong>
    </div>

    <!-- アイコン選択 -->
    <div class="d-flex justify-content-around my-2">
      <div class="text-center">
        <%= image_tag "milk.png", style: "height: 24px;" %><br>ミルク
      </div>
      <div class="text-center">
        <%= image_tag "sleep.png", style: "height: 24px;" %><br>睡眠
      </div>
      <div class="text-center">
        <%= image_tag "diaper.png", style: "height: 24px;" %><br>排泄
      </div>
    </div>

    <!-- 今やるべきタスク -->
    <div class="text-center p-2 rounded mt-3 fw-bold" style="background-color: #fff3cd;">
      今やるべきタスク：<%= @next_task || "未定" %>
    </div>
  </div>
<% end %>

<!-- モーダルたちは分岐の外で常に表示可能にする -->
<%= render "shared/child_modals" %>
<%= render "shared/routine_modal" %>
<%= render "shared/record_modal" %>

<!-- 子ども登録モーダル -->
<div class="modal fade" id="childModal" tabindex="-1" aria-labelledby="childModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="childModalLabel">子どもを登録</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <%= form_with(model: Child.new, url: children_path, local: true) do |f| %>
          <div class="mb-3">
            <%= f.label :name %>
            <%= f.text_field :name, class: "form-control" %>
          </div>
          <div class="mb-3">
            <%= f.label :birth_date %>
            <%= f.date_field :birth_date, class: "form-control" %>
          </div>
          <div class="mb-3">
            <%= f.label :gender %>
            <%= f.select :gender, [["男の子", "boy"], ["女の子", "girl"]], {}, class: "form-select" %>
          </div>
          <%= f.submit "登録", class: "btn btn-primary" %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- 子ども編集モーダル -->
<div class="modal fade" id="editChildModal" tabindex="-1" aria-labelledby="editChildModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editChildModalLabel">子ども情報を編集</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <% if @children.present? %>
          <%= form_with(model: @children.first, url: child_path(@children.first), method: :patch, local: true) do |f| %>
            <div class="mb-3">
              <%= f.label :name %>
              <%= f.text_field :name, class: "form-control" %>
            </div>
            <div class="mb-3">
              <%= f.label :birth_date %>
              <%= f.date_field :birth_date, class: "form-control" %>
            </div>
            <div class="mb-3">
              <%= f.label :gender %>
              <%= f.select :gender, [["男の子", "boy"], ["女の子", "girl"]], {}, class: "form-select" %>
            </div>
            <%= f.submit "更新", class: "btn btn-primary" %>
          <% end %>
        <% else %>
          <p>編集できる子どもがいません。</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- ルーティン登録モーダル -->
<div class="modal fade" id="routineModal" tabindex="-1" aria-labelledby="routineModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="routineModalLabel">ルーティンを追加</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <% if @children.present? %>
          <%= form_with(model: [@children.first, Routine.new], url: child_routines_path(@children.first), local: true) do |f| %>
            <div class="mb-3">
              <%= f.label :time %>
              <%= f.time_field :time, class: "form-control" %>
            </div>
            <div class="mb-3">
              <%= f.label :task %>
              <%= f.text_field :task, class: "form-control" %>
            </div>
            <div class="mb-3">
              <%= f.label :category %>
              <%= f.select :category, Routine.categories.map { |k,v| [v, k] }, {}, class: "form-select" %>
            </div>
            <div class="mb-3">
              <%= f.label :memo %>
              <%= f.text_area :memo, class: "form-control" %>
            </div>
            <%= f.submit "追加", class: "btn btn-success" %>
          <% end %>
        <% else %>
          <p>子どもが登録されていません。</p>
        <% end %>
      </div>
    </div>
  </div>
</div>
<!-- モーダルを開くボタン -->
<div class="text-center my-3">
  <button class="btn btn-outline-warning rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#recordModal">＋ 育児記録</button>
</div>

<!-- 育児記録登録モーダル -->
<div class="modal fade" id="recordModal" tabindex="-1" aria-labelledby="recordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="recordModalLabel">育児記録を追加</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <% if @children.present? %>
          <%= form_with(model: [@children.first, Record.new], url: child_records_path(@children.first), local: true) do |f| %>
            <div class="mb-3">
              <%= f.label :record_type, "記録の種類" %>
              <%= f.select :record_type, Record.record_types.map { |k, _| [k.humanize, k] }, {}, class: "form-select" %>
            </div>
            <div class="mb-3">
              <%= f.label :category, "カテゴリ" %>
              <%= f.select :category, Record.categories.map { |k, v| [v, k] }, {}, class: "form-select" %>
            </div>
            <div class="mb-3">
              <%= f.label :quantity, "量や回数" %>
              <%= f.number_field :quantity, class: "form-control" %>
            </div>
            <div class="mb-3">
              <%= f.label :recorded_at, "記録日時" %>
              <%= f.datetime_local_field :recorded_at, value: Time.current.strftime("%Y-%m-%dT%H:%M"), class: "form-control" %>            </div>
            <div class="mb-3">
              <%= f.label :memo, "メモ" %>
              <%= f.text_area :memo, class: "form-control", rows: 2 %>
            </div>
            <div class="text-end">
              <%= f.submit "記録する", class: "btn btn-primary" %>
            </div>
          <% end %>
        <% else %>
          <p>まず子どもを登録してください。</p>
        <% end %>
      </div>
    </div>
  </div>
</div>