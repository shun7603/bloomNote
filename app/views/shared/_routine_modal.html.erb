<!-- „É´„Éº„ÉÜ„Ç£„É≥ËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="routineModal" tabindex="-1" aria-labelledby="routineModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="routineModalLabel">„É´„Éº„ÉÜ„Ç£„É≥„ÇíËøΩÂä†</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
<% if flash[:routine_errors] %>
  <div class="alert alert-danger">
    <ul class="mb-2">
      <% flash[:routine_errors].each do |msg| %>
        <li><%= msg %></li>
      <% end %>
    </ul>
  </div>
<% end %>

        <% if @children.present? %>
<%= form_with(model: [@current_child, Routine.new(flash[:routine_attributes] || {})], url: child_routines_path(@current_child), local: true) do |f| %>
            <div class="mb-3">
              <%= f.label :time, "ÊôÇÈñì" %>
              <%= f.time_field :time, class: "form-control" %>
            </div>
            <div class="mb-3">
              <%= f.label :task, "Ë®òÈå≤„ÅÆÁ®ÆÈ°û" %>
              <%= f.select :task, Routine.task_options_for_select, { prompt: "ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ" }, class: "form-select" %>
            </div>
            <div class="mb-3">
              <%= f.label :memo, "„É°„É¢Ôºà‰ªªÊÑèÔºâ" %>
              <%= f.text_area :memo, class: "form-control", rows: 2 %>
            </div>
            <div class="mb-3">
              <%= f.label :photo, "ÂÜôÁúüÔºà‰ªªÊÑèÔºâ" %>
              <%= f.file_field :photo, class: "form-control" %>
            </div>
            <div class="text-end">
              <%= f.submit "ËøΩÂä†", class: "btn btn-success" %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted">„Åæ„ÅöÂ≠ê„Å©„ÇÇ„ÇíÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- „É´„Éº„ÉÜ„Ç£„É≥Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="routineDetailModal" tabindex="-1" aria-labelledby="routineDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="routineDetailModalLabel">„É´„Éº„ÉÜ„Ç£„É≥‰∏ÄË¶ß</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
<div class="modal-body">
  <% if @current_child && @current_child.routines.any? %>
    <ul class="list-group">
      <% @current_child.routines.order(:time).each do |routine| %>
        <% task_value = routine.task_before_type_cast.to_i %>
        <% task_key = Routine.tasks.key(task_value) %>
        <% task_label = Routine.task_labels[task_key] || "‰∏çÊòé„Å™„Çø„Çπ„ÇØ" %>
        <li class="list-group-item d-flex justify-content-between align-items-start">
          <div>
            <strong><%= task_label %></strong>
            <div class="text-muted small">üïí <%= routine.time.strftime('%H:%M') %></div>
            <% if routine.memo.present? %>
              <div class="text-muted small">üìù <%= routine.memo %></div>
            <% end %>
          </div>

  <!-- Á∑®ÈõÜ„ÉªÂâäÈô§„Éú„Çø„É≥ -->
<% if current_user.id == routine.child.user_id %>
  <div class="text-end">
    <%= link_to "Á∑®ÈõÜ", "#", class: "btn btn-sm btn-outline-secondary",
                data: { bs_toggle: "modal", bs_target: "#editRoutineModal-#{routine.id}", turbo: false } %>

    <%= button_to "ÂâäÈô§", child_routine_path(routine.child_id, routine),
        method: :delete,
        data: { turbo_confirm: "Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü" },
        class: "btn btn-sm btn-outline-danger",
        form: { class: "d-inline" } %>
  </div>
<% end %>

              <!-- Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ÔºàÂÄãÂà•„Å´Âá∫ÂäõÔºâ -->
              <div class="modal fade" id="editRoutineModal-<%= routine.id %>" tabindex="-1" aria-labelledby="editRoutineModalLabel-<%= routine.id %>" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <%= form_with(model: routine, url: child_routine_path(routine.child_id, routine), method: :patch, local: true) do |f| %>
                      <div class="modal-header">
                        <h5 class="modal-title" id="editRoutineModalLabel-<%= routine.id %>">„É´„Éº„ÉÜ„Ç£„É≥„ÇíÁ∑®ÈõÜ</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <% if flash[:routine_errors] && flash[:open_modal] == "editRoutineModal-#{routine.id}" %>
                          <div class="alert alert-danger">
                            <ul>
                              <% flash[:routine_errors].each do |msg| %>
                                <li><%= msg %></li>
                              <% end %>
                            </ul>
                          </div>
                        <% end %>

                        <div class="mb-3">
                          <%= f.label :time, "ÊôÇÈñì" %>
                          <%= f.time_field :time, class: "form-control" %>
                        </div>
                        <div class="mb-3">
                          <%= f.label :task, "Ë®òÈå≤„ÅÆÁ®ÆÈ°û" %>
                          <%= f.select :task, Routine.task_options_for_select, {}, class: "form-select" %>
                        </div>
                        <div class="mb-3">
                          <%= f.label :memo, "„É°„É¢" %>
                          <%= f.text_area :memo, class: "form-control", rows: 2 %>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <%= f.submit "Êõ¥Êñ∞", class: "btn btn-primary" %>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </ul>
        <% else %>
          <p class="text-muted">„É´„Éº„ÉÜ„Ç£„É≥„ÅØÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% if flash[:open_modal] %>
  <script>
    document.addEventListener("turbo:load", () => {
      const modalId = "<%= flash[:open_modal] %>";
      const modalElement = document.getElementById(modalId);
      if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
    });
  </script>
<% end %>